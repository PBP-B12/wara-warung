{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token }}">

    <title>Menu Planning</title>

    <!-- Import Poppins font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      body {
        background-color: #fffbf2;
        font-family: 'Poppins', sans-serif;
      }

      .input-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #ff6e1f;
        border-radius: 32px;
        box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
        padding: 0.5rem 1rem;
        width: 450px; 
        height: 64px;
      }

      .input-label {
        font-size: 1.2rem;
        font-weight: bold;
        color: white;
        margin-right: 10px;
      }

      .input-field {
        background-color: white;
        border: none;
        border-radius: 24px;
        box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
        padding: 0.5rem 1rem;
        width: 400px; 
        height: 47px;
        font-size: 1.1rem;
        color: black;
      }

      .flex-inputs {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
      }

      .navbar-height {
        height: 64px; 
      }

      .warung-container {
        margin-left: 60px; 
      }

      .budget-container {
        margin-right: 60px; 
      }

      .card {
        background: linear-gradient(180deg, #f5e6c5 0%, #ffc5a5 100%);
        width: 325px;
        height: 420px;
        flex-shrink: 0;
        border-radius: 36px;
      }

      .quantity-control {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #ff6e1f;
        border-radius: 24px;
        width: 40px;
        height: 40px;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        margin: 0 10px;
      }

      .quantity-display {
        font-size: 1.2rem;
        color: black;
        font-weight: bold;
      }

      .quantity-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 40px;
      }

      main {
        flex: 1; 
      }

      .total-price {
        font-size: 1.5rem;
        font-weight: bold;
        margin-top: 1rem;
      }

      .content-wrapper {
        display: flex;
        flex: 1;
        padding-top: 6rem; 
      }

      .cart-view {
        position: fixed;
        top: calc(4rem + 3rem); /* Adjusted to start just below the navbar */
        bottom: 2vh; /* Ends before the footer */
        right: 0;
        width: 25%;
        background: #FFF;
        border-radius: 48px 0 0 48px;
        box-shadow: -4px 0px 20.5px 4px rgba(0, 0, 0, 0.2);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        justify-content: center; 
        align-items: center;
        overflow-y: auto;
        z-index: 50;
    }

      .menu-planning {
        width: 75%;
        padding: 2rem;
        margin-right: 25%;
      }

      
    </style>
  </head>

  <body class="flex flex-col min-h-screen bg-[#fffbf2] font-poppins">

    <nav class="absolute z-50">{% include 'navbar.html' %}</nav>
    

    <div class="flex flex-1 w-full">
    
    <!-- Menu Planning Section -->
        <div class="w-3/4 p-10 mt-10">
            <section class="text-center">
                <h1 class="text-4xl font-bold mb-2">Menu Planning</h1>
                <p class="text-lg text-gray-700 mb-8">Choose your warung and plan your menu with your preferred budget!</p>

                <!-- Input Fields and Cards -->
                <div class="flex flex-col items-center">
                    <div class="flex justify-center space-x-8 mt-8">
                        <div class="input-container warung-container">
                            <label for="warung" class="input-label">Warung:</label>
                            <input type="text" id="warung" value="Warung Lestari" class="input-field" /> 
                        </div>

                        <div class="input-container budget-container">
                            <label for="budget" class="input-label">Budget:</label>
                            <input type="text" id="budget" value="100000" class="input-field" onchange="updateMaxBudget()" />
                        </div>
                    </div>

                    <!-- Cards Section untuk menampilkan menus di warung (masih data manual dummy)-->
                    <div class="mt-10 grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
                    <!-- Card 1 -->
                        <div class="card bg-gradient-to-b from-[#f5e6c5] to-[#ffc5a5] max-w-[325px] w-full h-96 rounded-[36px] shadow-lg hover:scale-105 transition-transform duration-300">
                            <img src="https://cdn0-production-images-kly.akamaized.net/viaedBOpL4cP1IQ1AAJMBv5rjqc=/500x281/smart/filters:quality(75):strip_icc():format(webp)/kly-media-production/medias/2355329/original/078016000_1536562953-resep-masakan-sehari-hari.jpg" 
                                alt="Nasi Goreng" class="w-full h-48 object-cover rounded-t-[36px]" />
                            <div class="p-4 flex flex-col">
                                <h3 class="font-bold text-xl text-gray-800">Nasi Goreng</h3>
                                <p class="text-lg text-gray-600">Rp20.000</p>
                                <p class="text-sm text-gray-500">Available at: Warung Lestari</p>
                                <div class="quantity-wrapper flex justify-center mt-4">
                                    <button class="quantity-control" onclick="updateCart(-1, 1, 20000)">-</button>
                                    <span class="quantity-display mx-2" id="quantity-1">0</span>
                                    <button class="quantity-control" onclick="updateCart(1, 1, 20000)">+</button>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Card 2 -->
                        <div class="card bg-gradient-to-b from-[#f5e6c5] to-[#ffc5a5] max-w-[325px] w-full h-96 rounded-[36px] shadow-lg hover:scale-105 transition-transform duration-300">
                            <img src="https://cdn0-production-images-kly.akamaized.net/viaedBOpL4cP1IQ1AAJMBv5rjqc=/500x281/smart/filters:quality(75):strip_icc():format(webp)/kly-media-production/medias/2355329/original/078016000_1536562953-resep-masakan-sehari-hari.jpg" 
                                alt="Nasi Goreng" class="w-full h-48 object-cover rounded-t-[36px]" />
                            <div class="p-4 flex flex-col">
                                <h3 class="font-bold text-xl text-gray-800">Nasi Goreng</h3>
                                <p class="text-lg text-gray-600">Rp20.000</p>
                                <p class="text-sm text-gray-500">Available at: Warung Lestari</p>
                                <div class="quantity-wrapper flex justify-center mt-4">
                                    <button class="quantity-control" onclick="updateCart(-1, 2, 20000)">-</button>
                                    <span class="quantity-display mx-2" id="quantity-2">0</span>
                                    <button class="quantity-control" onclick="updateCart(1, 2, 20000)">+</button>
                                </div>
                            </div>
                        </div>

                        <!-- Card 3 -->
                        <div class="card bg-gradient-to-b from-[#f5e6c5] to-[#ffc5a5] max-w-[325px] w-full h-96 rounded-[36px] shadow-lg hover:scale-105 transition-transform duration-300">
                            <img src="https://cdn0-production-images-kly.akamaized.net/viaedBOpL4cP1IQ1AAJMBv5rjqc=/500x281/smart/filters:quality(75):strip_icc():format(webp)/kly-media-production/medias/2355329/original/078016000_1536562953-resep-masakan-sehari-hari.jpg" 
                                alt="Nasi Goreng" class="w-full h-48 object-cover rounded-t-[36px]" />
                            <div class="p-4 flex flex-col">
                                <h3 class="font-bold text-xl text-gray-800">Nasi Goreng</h3>
                                <p class="text-lg text-gray-600">Rp20.000</p>
                                <p class="text-sm text-gray-500">Available at: Warung Lestari</p>
                                <div class="quantity-wrapper flex justify-center mt-4">
                                    <button class="quantity-control" onclick="updateCart(-1, 3, 20000)">-</button>
                                    <span class="quantity-display mx-2" id="quantity-3">0</span>
                                    <button class="quantity-control" onclick="updateCart(1, 3, 20000)">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            
            </section>
        </div>

        <!-- Cart view  -->
        <div class="cart-view">
            <div class="text-center w-full">
                <h2 class="text-2xl font-bold mb-4">Your Cart</h2>
                <div 
                    id="cart-items">{% include 'menuplanning/cart_items.html' %}
                </div>
                <p class="total-price" id="total-price">Total Price: Rp0</p>
                <div>
                    <button id="save-button" onclick="saveCart()" class="text-white font-bold py-2 px-6 rounded-full mt-4 mb-4 cursor-pointer transform hover:scale-105 transition-transform duration-300" 
                    style="background-color: #64D16D;">
                    Save Menu</button>
                </div>
                <div>
                    <a href="{% url 'menuplanning:saved_menu_planning_page' %}" 
                        class="bg-[#252525] text-white font-bold py-2 px-6 rounded-full mt-2 transform transition-transform duration-300 ease-in-out transform hover:scale-110 hover:shadow-lg">
                        See My Saved Menus
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        {% include 'footer.html' %}
    </footer>


    <script>
        let MAX_BUDGET = parseInt(document.getElementById("budget").value) || 100000; // Set initial MAX_BUDGET

        function updateMaxBudget() {
            const budgetInput = document.getElementById("budget").value.replace(/\D/g, ''); // Remove non-numeric characters
            MAX_BUDGET = parseInt(budgetInput) || 100000; // Update MAX_BUDGET with the new value
        }

        function updateCart(change, itemId, price) {
            let quantityElement = document.getElementById('quantity-' + itemId);
            let currentQuantity = parseInt(quantityElement.textContent);
            let newQuantity = currentQuantity + change;

            if (newQuantity < 0) {
                newQuantity = 0;
            }

            // Update the quantity on the page
            quantityElement.textContent = newQuantity;

            // Send AJAX request to update the cart on the server
            $.ajax({
                url: '{% url "menuplanning:update_cart" %}',
                type: 'POST',
                data: {
                    'item_id': itemId,
                    'quantity': newQuantity,
                    'price': price,
                    'csrfmiddlewaretoken': '{{ csrf_token }}' 
                },
                success: function(response) {
                    // Update cart items and total price dynamically
                    $('#cart-items').html(response.updated_cart_html);
                    $('#total-price').text('Total Price: Rp' + response.total_price);

                    // Check if the total exceeds the maximum budget
                    if (response.total_price > MAX_BUDGET) {
                        // Display an error popup if over budget
                        alert(`Total exceeds your budget of Rp${MAX_BUDGET.toLocaleString()}. Please adjust your menu.`);
                        
                        // Update the save button text and disable it
                        $('#save-button').text('Exceeded Budget!').prop('disabled', true).css({
                            'background-color': 'red', 
                            'color': 'white',
                            'border-radius': '9999px', 
                            'padding': '0.5rem 1.5rem',  
                            'font-weight': 'bold',
                            'cursor': 'not-allowed'
                        });
                    } else {
                        // Re-enable the save button if the total is within the budget
                        $('#save-button').text('Save Menu').prop('disabled', false).css({
                            'background-color': '#64D16D',  
                            'color': 'white',
                            'border-radius': '9999px', 
                            'padding': '0.5rem 1.5rem',  
                            'font-weight': 'bold',
                            'cursor': 'pointer'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error updating cart:', error);
                }
            });
        }


        function saveCart() {
        // Send AJAX request to save the current cart state
            $.ajax({
                url: '{% url "menuplanning:save_cart" %}',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    // Show the confirmation popup with cart items
                    displayConfirmationPopup(response.saved_cart_html);
                },
                error: function(xhr, status, error) {
                    console.error('Error saving cart:', error);
                }
            });
        }

        function displayConfirmationPopup(cartHtml) {
            // Create the overlay for the confirmation popup
            let overlay = document.createElement('div');
            overlay.id = 'cart-overlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '1000';

            // Create the modal container for the cart confirmation
            let modal = document.createElement('div');
            modal.id = 'saved-cart-modal';
            modal.style.backgroundColor = 'white';
            modal.style.padding = '20px';
            modal.style.borderRadius = '10px';
            modal.style.width = '50%';

            // Add the cart content to the modal (this is dynamically passed HTML from the server)
            modal.innerHTML = cartHtml;

            // Add the Save and Edit buttons with the updated styles
            let buttonsContainer = document.createElement('div');
            buttonsContainer.style.marginTop = '20px';

            let saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.classList.add('bg-[#ff6e1f]', 'text-white', 'font-bold', 'py-2', 'px-6', 'rounded-full', 'cursor-pointer', 'transform', 'hover:scale-105', 'transition-transform', 'duration-300');

            let editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.classList.add('bg-[#252525]', 'text-white', 'font-bold', 'py-2', 'px-6', 'rounded-full', 'cursor-pointer', 'ml-4', 'transform', 'hover:scale-105', 'transition-transform', 'duration-300');

            buttonsContainer.appendChild(saveButton);
            buttonsContainer.appendChild(editButton);

            modal.appendChild(buttonsContainer);

            // Append the modal to the overlay
            overlay.appendChild(modal);

            // Append the overlay to the body
            document.body.appendChild(overlay);

            // Handle Save and Edit button actions
            saveButton.onclick = function() {
                confirmSaveCart(); // Call the function to confirm save
            };

            editButton.onclick = function() {
                document.body.removeChild(overlay); // Close the popup and allow editing
            };
        }

        function confirmSaveCart() {
            // Send the final confirmation AJAX request to save the cart to the user's database
            $.ajax({
                url: '{% url "menuplanning:confirm_save_cart" %}',  // This should now resolve correctly
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    alert('Cart saved successfully!');
                    document.body.removeChild(document.getElementById('cart-overlay')); // Close the popup
                },
                error: function(xhr, status, error) {
                    console.error('Error confirming cart save:', error);
                }
            });

        }
    </script>


  </body>
</html>

